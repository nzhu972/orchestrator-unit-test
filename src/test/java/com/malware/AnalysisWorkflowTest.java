package com.malware;

import org.jbpm.test.JbpmJUnitBaseTestCase;
import org.jbpm.ruleflow.instance.RuleFlowProcessInstance;
import org.junit.Test;
import org.kie.api.runtime.KieSession;
import org.kie.api.runtime.manager.RuntimeEngine;
import org.kie.api.runtime.manager.RuntimeManager;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;


public class AnalysisWorkflowTest extends JbpmJUnitBaseTestCase{
    private static final Logger log = LoggerFactory.getLogger(AnalysisWorkflowTest.class);

    private RuntimeManager runtimeManager;
    private RuntimeEngine runtimeEngine;
    private KieSession kieSession;

    public AnalysisWorkflowTest() {
        super(true, true);
    }
    /*
     * JUnit test case to test the workflow defined in business central. 
     * The name of the workflow is FileAnalysis.bpmn
     * Prerequisite: Must build and deploy the orchestrator project in business central prior to 
     * running the unit test case to ensure the latest update is included from the bpmn file. 
     * 
     * Workitem handler which is implemented in the workflow is mocked so no live rest api calls are made.
     * The purpose of the test case is to confirm the workflow is moving from one node to another.
     */
    @Test
    public void testSidGeneratorProcess() {

        runtimeManager = createRuntimeManager("com/malware/analysisworkflow/FileAnalysis.bpmn");
        runtimeEngine = getRuntimeEngine();
        kieSession = runtimeEngine.getKieSession();

        // register a test handler for "Rest" 
        TestWorkItemHandler testHandler = getTestWorkItemHandler();

        kieSession.getWorkItemManager().registerWorkItemHandler("Rest", testHandler);
        
        // start the workflow instance
        RuleFlowProcessInstance processInstance = (RuleFlowProcessInstance) kieSession.startProcess("AnalysisWorkflow.DynamicStaticAnalysis");

        log.info("->>> Workflow processInstance {} started", processInstance.getId());
        
        
        assertProcessInstanceActive(processInstance.getId());
        assertNodeTriggered(processInstance.getId(), "SID Generator");        
        
        kieSession.dispose();
        runtimeManager.disposeRuntimeEngine(runtimeEngine);
        runtimeManager.close();
    }
    
    @Test
    public void testSubmissionProcess() {

        runtimeManager = createRuntimeManager("com/malware/analysisworkflow/FileAnalysis.bpmn");
        runtimeEngine = getRuntimeEngine();
        kieSession = runtimeEngine.getKieSession();

        // register a test handler for "Rest" 
        TestWorkItemHandler testHandler = getTestWorkItemHandler();

        kieSession.getWorkItemManager().registerWorkItemHandler("Rest", testHandler);
        
        // start the workflow instance
        RuleFlowProcessInstance processInstance = (RuleFlowProcessInstance) kieSession.startProcess("AnalysisWorkflow.DynamicStaticAnalysis");

        log.info("->>> Workflow processInstance {} started", processInstance.getId());

        // retrieve the workitem handler id for id generator
        long workItemId = testHandler.getWorkItem().getId();
        
        log.info("->>> Workitem id {} started", workItemId);
        
        // complete id generator so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(workItemId, null);
        

        // retrieve the workitem handler id for submission record
        long submissionWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> Submission Workitem id {} started", submissionWorkItemId);
        
        assertProcessInstanceActive(processInstance.getId());
        assertNodeTriggered(processInstance.getId(), "SID Generator");        
        assertNodeTriggered(processInstance.getId(), "Submission");
        
        kieSession.dispose();
        runtimeManager.disposeRuntimeEngine(runtimeEngine);
        runtimeManager.close();
    }

    @Test
    public void testTidGeneratorProcess() {

        runtimeManager = createRuntimeManager("com/malware/analysisworkflow/FileAnalysis.bpmn");
        runtimeEngine = getRuntimeEngine();
        kieSession = runtimeEngine.getKieSession();

        // register a test handler for "Rest" 
        TestWorkItemHandler testHandler = getTestWorkItemHandler();

        kieSession.getWorkItemManager().registerWorkItemHandler("Rest", testHandler);
        
        // start the workflow instance
        RuleFlowProcessInstance processInstance = (RuleFlowProcessInstance) kieSession.startProcess("AnalysisWorkflow.DynamicStaticAnalysis");

        log.info("->>> Workflow processInstance {} started", processInstance.getId());

        // retrieve the workitem handler id for sid generator
        long workItemId = testHandler.getWorkItem().getId();
        
        log.info("->>> Workitem id {} started", workItemId);
        
        // complete id generator so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(workItemId, null);
        

        // retrieve the workitem handler id for submission record
        long submissionWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> Submission Workitem id {} started", submissionWorkItemId);
        
        // complete submission record so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(submissionWorkItemId, null);
        
        assertProcessInstanceActive(processInstance.getId());
        assertNodeTriggered(processInstance.getId(), "SID Generator");        
        assertNodeTriggered(processInstance.getId(), "Submission");
        assertNodeTriggered(processInstance.getId(), "TID Generator");
        
        kieSession.dispose();
        runtimeManager.disposeRuntimeEngine(runtimeEngine);
        runtimeManager.close();
    }
    
    @Test
    public void testMoveFileProcess() {

        runtimeManager = createRuntimeManager("com/malware/analysisworkflow/FileAnalysis.bpmn");
        runtimeEngine = getRuntimeEngine();
        kieSession = runtimeEngine.getKieSession();

        // register a test handler for "Rest" 
        TestWorkItemHandler testHandler = getTestWorkItemHandler();

        kieSession.getWorkItemManager().registerWorkItemHandler("Rest", testHandler);
        
        // start the workflow instance
        RuleFlowProcessInstance processInstance = (RuleFlowProcessInstance) kieSession.startProcess("AnalysisWorkflow.DynamicStaticAnalysis");

        log.info("->>> Workflow processInstance {} started", processInstance.getId());

        // retrieve the workitem handler id for sid generator
        long workItemId = testHandler.getWorkItem().getId();
        
        log.info("->>> Workitem id {} started", workItemId);
        
        // complete id generator so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(workItemId, null);
        

        // retrieve the workitem handler id for submission record
        long submissionWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> Submission Workitem id {} started", submissionWorkItemId);
        
        // complete submission record so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(submissionWorkItemId, null);

        // retrieve the workitem handler id for submission record
        long TidWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> Submission Workitem id {} started", TidWorkItemId);
        
        // complete submission record so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(TidWorkItemId, null);
        
        assertProcessInstanceActive(processInstance.getId());
        assertNodeTriggered(processInstance.getId(), "SID Generator");        
        assertNodeTriggered(processInstance.getId(), "Submission");
        assertNodeTriggered(processInstance.getId(), "TID Generator");
        assertNodeTriggered(processInstance.getId(), "Move File");
        
        kieSession.dispose();
        runtimeManager.disposeRuntimeEngine(runtimeEngine);
        runtimeManager.close();
    }
    
    @Test
    public void testHashFileProcess() {

        runtimeManager = createRuntimeManager("com/malware/analysisworkflow/FileAnalysis.bpmn");
        runtimeEngine = getRuntimeEngine();
        kieSession = runtimeEngine.getKieSession();

        // register a test handler for "Rest" 
        TestWorkItemHandler testHandler = getTestWorkItemHandler();

        kieSession.getWorkItemManager().registerWorkItemHandler("Rest", testHandler);
        
        // start the workflow instance
        RuleFlowProcessInstance processInstance = (RuleFlowProcessInstance) kieSession.startProcess("AnalysisWorkflow.DynamicStaticAnalysis");

        log.info("->>> Workflow processInstance {} started", processInstance.getId());

        // retrieve the workitem handler id for sid generator
        long workItemId = testHandler.getWorkItem().getId();
        
        log.info("->>> Workitem id {} started", workItemId);
        
        // complete id generator so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(workItemId, null);
        

        // retrieve the workitem handler id for submission record
        long submissionWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> Submission Workitem id {} started", submissionWorkItemId);
        
        // complete submission record so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(submissionWorkItemId, null);

        // retrieve the workitem handler id for submission record
        long tidWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> Submission Workitem id {} started", tidWorkItemId);
        
        // complete submission record so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(tidWorkItemId, null);
        
        // retrieve the workitem handler id for submission record
        long moveFileWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> Submission Workitem id {} started", moveFileWorkItemId);
        
        // complete submission record so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(moveFileWorkItemId, null);
        
        assertProcessInstanceActive(processInstance.getId());
        assertNodeTriggered(processInstance.getId(), "SID Generator");        
        assertNodeTriggered(processInstance.getId(), "Submission");
        assertNodeTriggered(processInstance.getId(), "TID Generator");
        assertNodeTriggered(processInstance.getId(), "Move File");
        assertNodeTriggered(processInstance.getId(), "Hash File");
        
        kieSession.dispose();
        runtimeManager.disposeRuntimeEngine(runtimeEngine);
        runtimeManager.close();
    }
    
    @Test
    public void testCreateMetadataProcess() {

        runtimeManager = createRuntimeManager("com/malware/analysisworkflow/FileAnalysis.bpmn");
        runtimeEngine = getRuntimeEngine();
        kieSession = runtimeEngine.getKieSession();

        // register a test handler for "Rest" 
        TestWorkItemHandler testHandler = getTestWorkItemHandler();

        kieSession.getWorkItemManager().registerWorkItemHandler("Rest", testHandler);
        
        // start the workflow instance
        RuleFlowProcessInstance processInstance = (RuleFlowProcessInstance) kieSession.startProcess("AnalysisWorkflow.DynamicStaticAnalysis");

        log.info("->>> Workflow processInstance {} started", processInstance.getId());

        // retrieve the workitem handler id for sid generator
        long workItemId = testHandler.getWorkItem().getId();
        
        log.info("->>> Workitem id {} started", workItemId);
        
        // complete id generator so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(workItemId, null);
        

        // retrieve the workitem handler id for submission record
        long submissionWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> Submission Workitem id {} started", submissionWorkItemId);
        
        // complete submission record so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(submissionWorkItemId, null);

        // retrieve the workitem handler id for submission record
        long tidWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> Submission Workitem id {} started", tidWorkItemId);
        
        // complete submission record so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(tidWorkItemId, null);
        
        // retrieve the workitem handler id for submission record
        long moveFileWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> Submission Workitem id {} started", moveFileWorkItemId);
        
        // complete submission record so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(moveFileWorkItemId, null);
        
        // retrieve the workitem handler id for submission record
        long hashWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> Submission Workitem id {} started", hashWorkItemId);
        
        // complete submission record so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(hashWorkItemId, null);
        
        assertProcessInstanceActive(processInstance.getId());
        assertNodeTriggered(processInstance.getId(), "SID Generator");        
        assertNodeTriggered(processInstance.getId(), "Submission");
        assertNodeTriggered(processInstance.getId(), "TID Generator");
        assertNodeTriggered(processInstance.getId(), "Move File");
        assertNodeTriggered(processInstance.getId(), "Hash File");
        assertNodeTriggered(processInstance.getId(), "Create Metadata");
        
        kieSession.dispose();
        runtimeManager.disposeRuntimeEngine(runtimeEngine);
        runtimeManager.close();
    }
    
    @Test
    public void testNsrlLookupProcess() {

        runtimeManager = createRuntimeManager("com/malware/analysisworkflow/FileAnalysis.bpmn");
        runtimeEngine = getRuntimeEngine();
        kieSession = runtimeEngine.getKieSession();

        // register a test handler for "Rest" 
        TestWorkItemHandler testHandler = getTestWorkItemHandler();

        kieSession.getWorkItemManager().registerWorkItemHandler("Rest", testHandler);
        
        // start the workflow instance
        RuleFlowProcessInstance processInstance = (RuleFlowProcessInstance) kieSession.startProcess("AnalysisWorkflow.DynamicStaticAnalysis");

        log.info("->>> Workflow processInstance {} started", processInstance.getId());

        // retrieve the workitem handler id for sid generator
        long workItemId = testHandler.getWorkItem().getId();
        
        log.info("->>> Workitem id {} started", workItemId);
        
        // complete id generator so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(workItemId, null);
        

        // retrieve the workitem handler id for submission record
        long submissionWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> Submission Workitem id {} started", submissionWorkItemId);
        
        // complete submission record so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(submissionWorkItemId, null);

        // retrieve the workitem handler id for submission record
        long tidWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> Submission Workitem id {} started", tidWorkItemId);
        
        // complete submission record so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(tidWorkItemId, null);
        
        // retrieve the workitem handler id for move file
        long moveFileWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> move file Workitem id {} started", moveFileWorkItemId);
        
        // complete movefile so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(moveFileWorkItemId, null);
        
        // retrieve the hash file workitem id
        long hashWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> hash file Workitem id {} started", hashWorkItemId);
        
        // complete hash file so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(hashWorkItemId, null);
        
        // retrieve the workitem handler id for create metadata
        long createMetadataWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> create metadata Workitem id {} started", createMetadataWorkItemId);
        
        // complete create metadata so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(createMetadataWorkItemId, null);
        
        assertProcessInstanceActive(processInstance.getId());
        assertNodeTriggered(processInstance.getId(), "SID Generator");        
        assertNodeTriggered(processInstance.getId(), "Submission");
        assertNodeTriggered(processInstance.getId(), "TID Generator");
        assertNodeTriggered(processInstance.getId(), "Move File");
        assertNodeTriggered(processInstance.getId(), "Hash File");
        assertNodeTriggered(processInstance.getId(), "Create Metadata");
        assertNodeTriggered(processInstance.getId(), "NSRL Lookup");
        
        kieSession.dispose();
        runtimeManager.disposeRuntimeEngine(runtimeEngine);
        runtimeManager.close();
    }
    
    @Test
    public void testCreateTransactionRecordProcess() {

        runtimeManager = createRuntimeManager("com/malware/analysisworkflow/FileAnalysis.bpmn");
        runtimeEngine = getRuntimeEngine();
        kieSession = runtimeEngine.getKieSession();

        // register a test handler for "Rest" 
        TestWorkItemHandler testHandler = getTestWorkItemHandler();

        kieSession.getWorkItemManager().registerWorkItemHandler("Rest", testHandler);
        
        // start the workflow instance
        RuleFlowProcessInstance processInstance = (RuleFlowProcessInstance) kieSession.startProcess("AnalysisWorkflow.DynamicStaticAnalysis");

        log.info("->>> Workflow processInstance {} started", processInstance.getId());

        // retrieve the workitem handler id for sid generator
        long workItemId = testHandler.getWorkItem().getId();
        
        log.info("->>> Workitem id {} started", workItemId);
        
        // complete id generator so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(workItemId, null);
        

        // retrieve the workitem handler id for submission record
        long submissionWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> Submission Workitem id {} started", submissionWorkItemId);
        
        // complete submission record so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(submissionWorkItemId, null);

        // retrieve the workitem handler id for submission record
        long tidWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> Submission Workitem id {} started", tidWorkItemId);
        
        // complete submission record so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(tidWorkItemId, null);
        
        // retrieve the workitem handler id for move file
        long moveFileWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> move file Workitem id {} started", moveFileWorkItemId);
        
        // complete movefile so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(moveFileWorkItemId, null);
        
        // retrieve the hash file workitem id
        long hashWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> hash file Workitem id {} started", hashWorkItemId);
        
        // complete hash file so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(hashWorkItemId, null);
        
        // retrieve the workitem handler id for create metadata
        long createMetadataWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> create metadata Workitem id {} started", createMetadataWorkItemId);
        
        // complete create metadata so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(createMetadataWorkItemId, null);
        
        // retrieve the workitem handler id for create transaction record
        long createTransactionRecordWorkItemId = testHandler.getWorkItem().getId();
        log.info("->>> create transaction record Workitem id {} started", createTransactionRecordWorkItemId);
        
        // complete create transaction record so the workflow can move on to the next node
        kieSession.getWorkItemManager().completeWorkItem(createTransactionRecordWorkItemId, null);
        
        assertProcessInstanceActive(processInstance.getId());
        assertNodeTriggered(processInstance.getId(), "SID Generator");        
        assertNodeTriggered(processInstance.getId(), "Submission");
        assertNodeTriggered(processInstance.getId(), "TID Generator");
        assertNodeTriggered(processInstance.getId(), "Move File");
        assertNodeTriggered(processInstance.getId(), "Hash File");
        assertNodeTriggered(processInstance.getId(), "Create Metadata");
        assertNodeTriggered(processInstance.getId(), "NSRL Lookup");
        assertNodeTriggered(processInstance.getId(), "Create Transaction Record");
        
        kieSession.dispose();
        runtimeManager.disposeRuntimeEngine(runtimeEngine);
        runtimeManager.close();
    }
}
